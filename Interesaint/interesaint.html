<!DOCTYPE HTML>
<html lang="en">
<head>
<title>Interesaint</title>
<script type="text/javascript" src="https://www.google.com/jsapi?key=ABQIAAAAdIOW2ntfXQiIaSgX0c8KpRS8QIXLX2ycRdTteZS2W1M7b4khSBReveKbOTim0FAVoHdOA0qWa9TbKg"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
<script type="text/javascript">
var items_ = [];
var subscriptions_ = [];
var page_ = 0;
var offset_ = 0;

function add() {
  var input = $("form input:text");
  $.post("script/add", { url: input.val() });
}

function remove() {
  var index = $("form select")[0].selectedIndex;
  // TODO(ariw): Remove subscription locally as well.
  $.post("script/remove", { id: subscriptions_[index]["id"] });
}

function printDate(d) {
  var d = new Date(d);
  if (d.toLocaleDateString() == new Date().toLocaleDateString()) {
    return d.toLocaleTimeString();
  } else {
    return d.toLocaleDateString();
  }
}

// TODO(ariw): Combine this with starsChange?
function starsHtml(item) {
  var html = "";
  for (var i = 0; i < 5; i++) {
    if (item["rating"] && item["rating"] >= (i + 1) / 5) {
      html += "<img src='images/goldstar.jpg' width='16' height='16'/>";
    } else if (item["predicted_rating"] &&
               item["predicted_rating"] >= (i + 1) / 5) {
      html += "<img src='images/silverstar.jpg' width='16' height='16'/>";
    } else {
      html += "<img src='images/whitestar.jpg' width='16' height='16'/>";
    }
  }
  return html
}

function starsChange(i, rating, predicted, stars) {
  for (var j = i * 5; j < (i + 1) * 5; j++) {
    if (j < i * 5 + rating) {
      if (!predicted) {
        stars[j].src = "images/goldstar.jpg";
      } else {
        stars[j].src = "images/silverstar.jpg";
      }
    } else {
      stars[j].src = "images/whitestar.jpg";
    }
  }
}

function moreItems() {
  $.post("script/items", { page: page_ }, function(data) {
    if (!data)
      return;
    items_ = items_.concat(eval(data));
    for (var i = offset_; i < items_.length; i++) {
      var checked = "";
      if (items_[i]["rating"] && items_[i]["rating"] > 0.0)
        checked = "checked='yes'";
      $("#items").append(
          "<tr><td>" + starsHtml(items_[i]) +
          "</td><td>" + items_[i]["feed_title"] +
          "</td><td><a href='" + items_[i]["url"] + "'>" + items_[i]["title"] +
          "</a></td><td>" + printDate(items_[i]["updated"]) + "</tr>");
    }
    var stars = $("img");
    stars.mouseover(function() {
      var index = stars.index(this);
      starsChange(Math.floor(index / 5), index % 5 + 1, false, stars);
    })
    stars.mouseout(function() {
      var index = stars.index(this);
      var i = Math.floor(index / 5);
      var rating = 0;
      var predicted = false;
      if (items_[i]["rating"]) {
        rating = 5 * items_[i]["rating"];
      } else if (items_[i]["predicted_rating"]) {
        rating = 5 * items_[i]["predicted_rating"];
        predicted = true;
      }
      starsChange(i, rating, predicted, stars);
    })
    stars.click(function() {
      var index = stars.index(this);
      var i = Math.floor(index / 5);
      items_[i]["rating"] = (index % 5 + 1) / 5;
      $.post("script/rate",
             { id: items_[i]["id"], rating: items_[i]["rating"] });
    })
    page_++;
    offset_ = items_.length;
  })
}

$(document).ready(function() {
  moreItems();
  $.post("script/subscriptions", function(data) {
    subscriptions_ = eval(data);
    for (var i = 0; i < subscriptions_.length; i++) {
      $("#remove").append(
        "<option>" + subscriptions_[i]["title"] + "</option>");
    }
  })
})
</script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-8943670-8']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body>
<table id="items">
</table>
<form action="javascript:moreItems()">
<input type="submit" value="More" />
</form>
<form action="javascript:add()">
Add new subscription: <input type="text" />
<input type="submit" value="Submit" />
</form>
<form action="javascript:remove()">
Remove subscription: <select id="remove"></select>
<input type="submit" value="Submit" />
</form>
</body>
</html>

