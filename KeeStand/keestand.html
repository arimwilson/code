<!DOCTYPE HTML>
<html lang="en" manifest="/cache.manifest">
<head>
<title>KeeStand</title>
<link type="text/css" href="css/cupertino/jquery-ui-1.8.9.custom.css" rel="Stylesheet" />
<script type="text/javascript" src="https://www.google.com/jsapi?key=ABQIAAAAdIOW2ntfXQiIaSgX0c8KpRS8QIXLX2ycRdTteZS2W1M7b4khSBReveKbOTim0FAVoHdOA0qWa9TbKg"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
<script type="text/javascript" src="sjcl.js"></script>
<script type="text/javascript">

function AssertException(message) {
  this.message = message;
}

AssertException.prototype.toString = function () {
  return "AssertException: " + this.message;
}

function assert(exp, message) {
  if (!exp) {
    throw new AssertException(message);
  }
}

$(document).ready(function() {
  var username_ = "";
  var password_ = "";
  var salt_ = "";
  var password_hash_ = "";
  var version_ = 1;
  var local_storage_ = false;
  var stop_ = false;

  // Display last used username, as a convenience.
  if (localStorage.getItem("username"))
    $("#username").val(localStorage["username"]);

  function decrypt(data) {
    assert(password_, "password_ is null.");
    return sjcl.decrypt(password_, data);
  }

  function create_accordion(active) {
    $("#data > div > h3").click(function(event) {
      if (stop_) {
        event.stopImmediatePropagation();
        event.preventDefault();
        stop_ = false;
      }
    });
    $("#data").accordion({collapsible: true, active: active,
                          header: "> div > h3"})
              .sortable({axis: "y", handle: "h3",
                         stop: function() { stop_ = true; }});
  }

  function add_input(input) {
    var output = $(
        "<div><h3><a href='#'><span class='org'>" + input[0] + "</span></a>" +
        "</h3><div><textarea rows=1 cols=20>" + input[1] + "</textarea>" +
        "<textarea rows=1 cols=20>" + input[2] + "</textarea>" +
        "<textarea rows=1 cols=20>" + input[3] + "</textarea>" +
        "<input type='button' value='Delete'></div>");
    output.find(".org").click(function(event) {
      var srcElement = event.srcElement? $(event.srcElement): $(event.target);
      var name = prompt("New name?", srcElement.html());
      if (name !== null && name !== "")
        srcElement.html(name);
      event.stopImmediatePropagation();
    });
    output.find("input:button").click(function(event) {
      var sure = confirm("Delete this password?");
      if (sure) {
        $("#data").accordion("destroy");
        var srcElement = event.srcElement? event.srcElement: event.target;
        var div = $(srcElement.parentNode.parentNode);
        div.remove();
        create_accordion(false);
      }
    });
    return output;
  }

  function editor(data) {
    $("#data").accordion("destroy").empty();
    data = data.split("\n");
    for (i = 0; i < data.length - 1; ++i) {
      data[i] = data[i].split(",");
      for (j = 0; j < data[i].length; ++j) {
        data[i][j] = unescape(data[i][j]);
      }
      $("#data").append(add_input(data[i]));
    }
    create_accordion(false);
  }

  function password_hash(password, salt) {
    hash = sjcl.hash.sha256.hash(password + salt);
    // TODO(ariw): Is 1000 right here? I wish I could use bcrypt...
    for (i = 1; i < 1000; ++i)
      hash = sjcl.hash.sha256.hash(hash);
    return sjcl.codec.base64.fromBits(hash, false);
  }

  function salt_success(data) {
    salt_ = data;
    password_hash_ = password_hash(password_, salt_);
    $.post("script/login",
           { username: username_, password_hash: password_hash_, salt: salt_ },
           function(data) {
             $("#login").hide();
             $("#edit").show();
             // Determine whether or not to use local storage based on last
             // modification date.
             if (local_storage_) {
               last_modified_local = new Date(localStorage["last_modified"]);
             }
             if (data) {
               last_modified = new Date(1000 * data["last_modified"]);
             }
             if (data &&
                 (!local_storage_ || last_modified >= last_modified_local)) {
               editor(decrypt(data["passwords"]));
               version_ = data["version"];
               save_local(data["passwords"], last_modified);
             } else if (local_storage_) {
               editor(decrypt(localStorage["passwords"]));
               version_ = parseInt(localStorage["version"])
               save(localStorage["passwords"]);
             }
           }, "json");
  }

  function salt_error(xhr, text_status, error_thrown) {
    if (local_storage_) {
      salt_ = localStorage["salt"];
      password_hash_ = localStorage["password_hash"];
      $("#login").hide();
      $("#edit").show();
      editor(decrypt(localStorage["passwords"]));
    }
  }

  // TODO(ariw): Validation on password length/content.
  $("#login_button").click(function() {
    username_ = $("#username").val();
    password_ = $("#password").val();
    local_storage_ =
        localStorage.getItem("username") &&
        localStorage["username"] === username_ &&
        localStorage.getItem("salt") &&
        localStorage.getItem("password_hash") &&
        localStorage.getItem("last_modified") &&
        localStorage.getItem("version") &&
        localStorage.getItem("passwords") &&
        password_hash(password_, localStorage["salt"]) === localStorage[
            "password_hash"];
    $.ajax({type: "POST", url: "script/salt", data: { username: username_ },
            timeout: 3000, success: salt_success, error: salt_error});
    return false;
  });

  $("#add_button").click(function() {
    $("#data").accordion("destroy").append(
        add_input(["Organization", "Username", "Password", "Notes"]));
    create_accordion($("#data > div:last > h3"));
  });

  function create_csv(input) {
    data = "";
    for (i = 0; i < input.length; i += 4) {
      data += escape(input[i].innerHTML) + "," +
              escape(input[i + 1].value) + "," +
              escape(input[i + 2].value) + "," +
              escape(input[i + 3].value) + "\n";
    }
    return data;
  }

  function encrypt(data) {
    assert(password_, "password_ is null.");
    return sjcl.encrypt(password_, data);
  }

  function save_local(passwords, last_modified) {
    assert(username_ && salt_ && password_hash_,
           "username_ or salt_ or password_hash_ is null.");
    localStorage["username"] = username_;
    localStorage["salt"] = salt_;
    localStorage["password_hash"] = password_hash_;
    localStorage["passwords"] = passwords;
    localStorage["last_modified"] = last_modified.toUTCString();
    localStorage["version"] = version_;
  }

  function save(passwords) {
    // TODO(ariw): Notify when successful.
    $.post("script/save", { passwords: passwords, version: version_ });
  }

  $("#save_button").click(function() {
    passwords = encrypt(create_csv($("#data").find(".org,textarea")));
    save_local(passwords, new Date());
    save(passwords);
  });

  $(".options_button").click(function() {
    $("#edit").hide();
    $("#gen_pw").hide();
    $("#import_csv").hide();
    $("#export_csv").hide();
    $("#options").show();
  });

  $("#edit_button").click(function() {
    $("#options").hide();
    $("#edit").show();
  });

  function get_random_num(lower, upper) {
    return (Math.floor(Math.random() * (upper - lower)) + lower);
  }

  var char_set = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVW" +
                 "XYZ`~!@#$%^&*()-_=+[{]}\\|;:'\",<.>/? ";
  function get_random_char() {
    return char_set.charAt(get_random_num(0, char_set.length));
  }

  function generate_password(length) {
    password = "";
    for (i = 0; i < length; ++i) {
      password += get_random_char();
    }
    return password;
  }

  $("#gen_pw_button").click(function() {
    $("#gen_pw_data").remove();
    $("#gen_pw").prepend("<div id='gen_pw_data'>" + generate_password(10) +
                         "</div>");
    $("#options").hide();
    $("#gen_pw").show();
  });

  $("#import_csv_button").click(function() {
    $("#options").hide();
    $("#import_csv").show();
  });

  $("#import_button").click(function() {
    data = $("#import_csv > form > textarea").val();
    if (!data) {
      alert("CSV is empty.");
      return;
    }
    $("#import_csv").hide();
    $("#edit").show();
    editor(data);
  });

  $("#export_csv_button").click(function() {
    input = $("#data").find(".org,textarea");
    $("#export_csv_data").remove();
    $("#export_csv").prepend("<div id='export_csv_data'>" +
                             create_csv(input).replace(/\n/g, "<br>") +
                             "</div>");
    $("#options").hide();
    $("#export_csv").show();
  });

  $("#delete_account_button").click(function() {
    var sure = confirm("Are you sure you want to delete your account?");
    if (sure) {
      var really_sure = confirm(
          "Are you really sure you want to delete your account? This action " +
          "cannot be undone!");
      if (really_sure) {
        localStorage.clear();
        // TODO(ariw): Alert if unable to delete for some reason.
        // TODO(ariw): This isn't actually sending requests for some reason...
        $.ajax("script/deleteaccount", {},
            function() { location.reload(true); });
      }
    }
  });
});
</script>
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(["_setAccount", "UA-8943670-6"]);
_gaq.push(["_trackPageview"]);

(function() {
  var ga = document.createElement("script");
  ga.type = "text/javascript";
  ga.async = true;
  ga.src = "https://ssl.google-analytics.com/ga.js";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
})();
</script>
</head>
<body>
<span id="login">
<form>
Username: <input type="text" name="username" id="username"><br>
Password: <input type="password" name="password" id="password"><br>
<input type="submit" id="login_button">
</form>
<br><i>New user? Type any username and password to get started. If the username  
is taken, you will receive an error message (hopefully!). 
<a href="http://goo.gl/2NJQq">Forgot your password?</a></i>
</span>
<span id="edit" style="display:none">
<form>
<div id="data">
</div>
<input type="button" value="Add" id="add_button">
<input type="button" value="Save" id="save_button">
<input type="button" value="Options" class="options_button">
</form>
</span>
<span id="options" style="display:none">
<input type="button" value="Back to editing" id="edit_button">
<input type="button" value="Generate password" id="gen_pw_button">
<input type="button" value="Import from CSV" id="import_csv_button">
<input type="button" value="Export to CSV" id="export_csv_button">
<input type="button" value="Delete account" id="delete_account_button">
</span>
<span id="gen_pw" style="display:none">
<input type="button" value="Back to options" class="options_button">
</span>
<span id="import_csv" style="display:none">
<form><textarea rows=20 cols=80></textarea></form>
<input type="button" value="Back to options" class="options_button">
<input type="button" value="Import" id="import_button">
</span>
<span id="export_csv" style="display:none">
<input type="button" value="Back to options" class="options_button">
</span>
</body>
</html>
