<html>
<head><title>KeeStand</title>
<script type="text/javascript" src="https://www.google.com/jsapi?key=ABQIAAAAdIOW2ntfXQiIaSgX0c8KpRS8QIXLX2ycRdTteZS2W1M7b4khSBReveKbOTim0FAVoHdOA0qWa9TbKg"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/dojo/1.5/dojo/dojo.xd.js"></script>
<script type="text/javascript" src="sjcl.js"></script>
<script type="text/javascript">
dojo.require("dojo.io.iframe");

function AssertException(message) {
  this.message = message;
}

AssertException.prototype.toString = function () {
  return 'AssertException: ' + this.message;
}

function assert(exp, message) {
  if (!exp) {
    throw new AssertException(message);
  }
}

$.ajaxSetup({async: false});

$(document).ready(function() {
  password_ = "";

  function decrypt(data) {
    assert(password_, "password_ is null.");
    return sjcl.decrypt(password_, data);
  }

  function editor(data) {
    // TODO(ariw): Generate an editor based on decrypted data.
  }

  // TODO(ariw): Validation on password length/content.
  $("#login_button").click(function() {
    username = $("#username").val();
    password_ = $("#password").val();
    // TODO(ariw): Add salt/adaptive hash to prevent me/Google from rainbow
    // attacking/brute forcing these passwords.
    password_hash = sjcl.codec.base64.fromBits(
        sjcl.hash.sha256.hash(password_, true));
    paths = "";
    $.post("script/login",
          { username: username, password_hash: password_hash },
          function(data) { paths = data; });
    if (paths != "FAIL") {  // Magic constants!
      $("#login").hide();
      encrypted = "";
      if (paths) {  // Existing data!
        encrypted_path = "script/load/" + paths;
        $.post(encrypted_path, function(data) { encrypted = data });
        editor(decrypt(encrypted));
      }
      $("#edit").show();
    }
    return false;
  });

  $("#add_button").click(function() {
    $("#data > form").append(
        "Username: <input type='text'> Password: <input type='text'> Notes: " +
        "<input type='text'> <br>");
  });

  function encrypt(data) {
    assert(password_, "password_ is null.");
    return sjcl.encrypt(password_, data);
  }

  $("#save_button").click(function() {
    input = $("#data > form > input");
    data = ""
    for (i = 0; i < input.length; i += 3) {
      data += escape(input[i].value) + " " + escape(input[i + 1].value) + " " +
              escape(input[i + 2].value) + "\n";
    }
    data = encrypt(data);
    save_url = ""
    $.post("/save_url", function(data) { save_url = data });
    // TODO(ariw): Call save URL.
    dojo.io.iframe.send({url: upload_url});
    return false;
  });
});
</script>
<body>
<span id="login">
<form>
Username: <input type="text" name="username" id="username"><br>
Password: <input type="password" name="password" id="password"><br>
<input type="submit" id="login_button">
</form>
</span>
<span id="edit" style="display:none">
<span id="data">
<form>
</form>
</span>
<span id="controls">
<form>
<input type="button" value="Add new password" id="add_button">
<input type="submit" value="Save" id="save_button">
</form>
</span>
</body>
</html>
