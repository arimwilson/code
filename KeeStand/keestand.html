<html>
<head><title>KeeStand</title>
<script type="text/javascript" src="https://www.google.com/jsapi?key=ABQIAAAAdIOW2ntfXQiIaSgX0c8KpRS8QIXLX2ycRdTteZS2W1M7b4khSBReveKbOTim0FAVoHdOA0qWa9TbKg"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<script type="text/javascript" src="sjcl.js"></script>
<script type="text/javascript">

function AssertException(message) {
  this.message = message;
}

AssertException.prototype.toString = function () {
  return "AssertException: " + this.message;
}

function assert(exp, message) {
  if (!exp) {
    throw new AssertException(message);
  }
}

$(document).ready(function() {
  password_ = "";

  function decrypt(data) {
    assert(password_, "password_ is null.");
    return sjcl.decrypt(password_, data);
  }

  function add_input(organization, username, password, notes) {
    $("#data").append(
        "<tr class='data_row'><td><input type='text' value='" + organization +
        "'></td><td><input type='text' value='" + username + "'></td>" +
        "<td><input type='text' value='" + password + "'></td>" +
        "<td><textarea rows=1 cols=20>" + notes + "</textarea></td>" +
        "<td><input type='button' value='Delete'></td></tr>");
    $("#data > tbody > tr > td >:last").click(function() {
      row = this.parentNode.parentNode;
      row.parentNode.removeChild(row);
    });
  }

  function editor(data) {
    $(".data_row").remove();
    data = data.split("\n");
    for (i = 0; i < data.length - 1; ++i) {
      data[i] = data[i].split(",");
      for (j = 0; j < data[i].length; ++j) {
        data[i][j] = unescape(data[i][j]);
      }
      add_input(data[i][0], data[i][1], data[i][2], data[i][3]);
    }
  }

  // TODO(ariw): Validation on password length/content.
  $("#login_button").click(function() {
    username = $("#username").val();
    password_ = $("#password").val();
    $.post("script/salt", { username: username }, function(data) {
      salt = data;
      password_hash = sjcl.hash.sha256.hash(password_ + salt);
      // TODO(ariw): Is 1000 right here? I wish I could use bcrypt...
      for (i = 1; i < 1000; ++i)
        password_hash = sjcl.hash.sha256.hash(password_hash);
      password_hash = sjcl.codec.base64.fromBits(password_hash, false);
      // TODO(ariw): Don't silently fail.
      $.post("script/login",
             { username: username, password_hash: password_hash, salt: salt },
             function(data, status) {
               if (status == "success") {
                 if (data) editor(decrypt(data));
                 $("#login").hide();
                 $("#edit").show();
               }
             });
    });
    return false;
  });

  $("#add_button").click(function() {
    add_input("", "", "", "");
  });

  function create_csv(input) {
    data = "";
    for (i = 0; i < input.length; i += 4) {
      data += escape(input[i].value) + "," + escape(input[i + 1].value) + "," +
              escape(input[i + 2].value) + "," + escape(input[i + 3].value) +
              "\n";
    }
    return data;
  }

  function encrypt(data) {
    assert(password_, "password_ is null.");
    return sjcl.encrypt(password_, data);
  }

  $("#save_button").click(function() {
    input = $("#data").find("input:text,textarea");
    // TODO(ariw): Don't silently fail.
    $.post("script/save", { passwords: encrypt(create_csv(input)) });
  });

  $(".options_button").click(function() {
    $("#edit").hide();
    $("#import_csv").hide();
    $("#export_csv").hide();
    $("#options").show();
  });

  $("#edit_button").click(function() {
    $("#options").hide();
    $("#edit").show();
  });

  $("#import_csv_button").click(function() {
    $("#options").hide();
    $("#import_csv").show();
  });

  $("#import_button").click(function() {
    data = $("#import_csv > form > textarea").val();
    if (!data) {
      alert("CSV is empty.");
      return;
    }
    editor(data);
    $("#import_csv").hide();
    $("#edit").show();
  });

  $("#export_csv_button").click(function() {
    input = $("#data").find("input:text,textarea");
    $("#export_csv").prepend(create_csv(input).replace(/\n/g, "<br>"));
    $("#options").hide();
    $("#export_csv").show();
  });

  $("#delete_account_button").click(function() {
    var sure = confirm("Are you sure you want to delete your account?");
    if (sure) {
      var really_sure = confirm(
          "Are you really sure you want to delete your account? This action " +
          "cannot be undone!");
      if (really_sure)
        $.post("script/deleteaccount", {}, function() { location.reload(true); });
    }
  });
});
</script>
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(["_setAccount", "UA-8943670-6"]);
_gaq.push(["_trackPageview"]);

(function() {
  var ga = document.createElement("script");
  ga.type = "text/javascript";
  ga.async = true;
  ga.src = ("https:" == document.location.protocol ?
            "https://ssl" : "http://www") + ".google-analytics.com/ga.js";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
})();
</script>
</head>
<body>
<span id="login">
<form>
Username: <input type="text" name="username" id="username"><br>
Password: <input type="password" name="password" id="password"><br>
<input type="submit" id="login_button">
</form>
</span>
<span id="edit" style="display:none">
<form>
<table id="data">
<tr>
  <th>Organization</th>
  <th>Username</th>
  <th>Password</th>
  <th>Comments</th>
</tr>
</table>
<input type="button" value="Add" id="add_button">
<input type="button" value="Save" id="save_button">
<input type="button" value="Options" class="options_button">
</form>
</span>
<span id="options" style=display:none">
<input type="button" value="Back to editing" id="edit_button">
<input type="button" value="Import from CSV" id="import_csv_button">
<input type="button" value="Export to CSV" id="export_csv_button">
<input type="button" value="Delete account" id="delete_account_button">
</span>
<span id="import_csv" style="display:none">
<form><textarea rows=20 cols=80></textarea></form>
<input type="button" value="Back to options" class="options_button">
<input type="button" value="Import" id="import_button">
</span>
<span id="export_csv" style="display:none">
<input type="button" value="Back to options" class="options_button">
</span>
</body>
</html>
